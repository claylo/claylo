name: On Release

on:
  release:
    types: [published]

jobs:
  trigger-build:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger build in dev repo
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DEV_REPO_PAT }}
          repository: claylo/dev
          event-type: blog-release
          client-payload: '{"tag": "${{ github.event.release.tag_name }}", "title": "${{ github.event.release.name }}"}'

  update-readme:
    runs-on: ubuntu-latest
    needs: trigger-build
    steps:
      - uses: actions/checkout@v4

      - name: Update README with latest posts
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });

            const posts = releases
              .filter(r => !r.draft && !r.prerelease)
              .map(r => `- [${r.name}](https://claylo.dev/blog/${r.tag_name}) â€” ${new Date(r.published_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`)
              .join('\n');

            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');

            const marker = '<!-- LATEST_POSTS -->';
            const endMarker = '<!-- /LATEST_POSTS -->';

            if (readme.includes(marker)) {
              const regex = new RegExp(`${marker}[\\s\\S]*?${endMarker}`, 'g');
              readme = readme.replace(regex, `${marker}\n${posts}\n${endMarker}`);
            } else {
              // Append if markers don't exist
              readme += `\n\n### Latest Posts\n${marker}\n${posts}\n${endMarker}\n`;
            }

            fs.writeFileSync('README.md', readme);

      - name: Commit README update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update latest posts"
          file_pattern: README.md
